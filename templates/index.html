
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pAIses - Adivinhe o País</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="shuffle-animation-overlay" class="hidden">
        <div class="flags-container">
            <!-- Flags will be dynamically added here or a few static ones -->
        </div>
    </div>
    <div class="container">
        <header>
            <h1>pAIses</h1>
            <p>O desafio é adivinhar o país com a menor quantidade de tentativas e tempo.</p>
        </header>

        <div id="start-screen" class="button-group-vertical">
            <div class="difficulty-selection">
                <label><input type="radio" name="difficulty" value="easy" checked> Fácil</label>
                <label><input type="radio" name="difficulty" value="medium"> Médio</label>
                <label><input type="radio" name="difficulty" value="hard"> Difícil</label>
            </div>
            <button id="start-game-btn">Iniciar Jogo</button>
            <button id="view-ranking-btn">Ver Ranking</button>
        </div>

        <div id="game-area" class="hidden">
            <p class="initial-letter-container">
                A primeira letra do país é: <span id="initial-letter">?</span>
            </p>
            
            <div class="button-group-vertical">
                <form id="guess-form">
                    <input type="text" id="guess-input" placeholder="Digite o nome de um país" autocomplete="off" required>
                    <button type="submit">Adivinhar</button>
                </form>
                <button id="give-up-btn" class="give-up-btn">Desistir da Rodada</button>
            </div>

            <div id="feedback-area">
                <!-- Mensagens de acerto/erro aparecerão aqui -->
            </div>

            <div id="wrong-guesses-area">
                <h3>Tentativas: <span id="total-attempts">0</span> | Erradas: <span id="error-count">0</span>/10</h3>
                <ul id="wrong-guesses-list">
                    <!-- Lista de tentativas erradas -->
                </ul>
            </div>
        </div>

        <div id="win-screen" class="hidden">
            <h2 id="win-message"></h2>
            <img id="country-flag" src="" alt="Bandeira do País">
            <div class="stats">
                <p>Tempo: <strong id="final-time">0</strong>s</p>
                <p>Tentativas: <strong id="final-attempts">0</strong></p>
            </div>
            <form id="ranking-form">
                <input type="text" id="player-name" placeholder="Digite seu nome para o ranking" required>
                <button type="submit">Salvar no Ranking</button>
            </form>
            <div class="button-group-vertical">
                <button id="play-again-btn">Jogar Novamente</button>
                <button id="view-ranking-btn-win">Ver Ranking</button>
            </div>
        </div>

        <div id="lose-screen" class="hidden">
            <h2 id="lose-message"></h2>
            <img id="country-flag-lose" src="" alt="Bandeira do País">
            <p>O país correto era: <strong id="correct-country"></strong></p>
            <p>Total de tentativas: <strong id="lose-attempts"></strong></p>
            <div class="button-group-vertical">
                <button id="play-again-btn-lose">Jogar Novamente</button>
                <button id="view-ranking-btn-lose">Ver Ranking</button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameArea = document.getElementById('game-area');
            const winScreen = document.getElementById('win-screen');
            const loseScreen = document.getElementById('lose-screen');
            const guessForm = document.getElementById('guess-form');
            const guessInput = document.getElementById('guess-input');
            const initialLetterEl = document.getElementById('initial-letter');
            const feedbackArea = document.getElementById('feedback-area');
            const errorCountEl = document.getElementById('error-count');
            const totalAttemptsEl = document.getElementById('total-attempts');
            const wrongGuessesList = document.getElementById('wrong-guesses-list');
            const rankingForm = document.getElementById('ranking-form');
            const playAgainBtn = document.getElementById('play-again-btn');
            const playAgainBtnLose = document.getElementById('play-again-btn-lose');
            const startScreen = document.getElementById('start-screen');
            const startGameBtn = document.getElementById('start-game-btn');
            const viewRankingBtn = document.getElementById('view-ranking-btn');
            const viewRankingBtnWin = document.getElementById('view-ranking-btn-win');
            const viewRankingBtnLose = document.getElementById('view-ranking-btn-lose');

            let finalTime = 0;
            let finalAttempts = 0;

            const shuffleAnimationOverlay = document.getElementById('shuffle-animation-overlay');
            const flagsContainer = shuffleAnimationOverlay.querySelector('.flags-container');
            const flagCodes = ['ad', 'br', 'us', 'fr', 'de', 'jp', 'cn', 'in', 'mx', 'ca']; // A few example flag codes

            // Function to populate flags for animation
            function populateFlagsForAnimation() {
                flagsContainer.innerHTML = ''; // Clear existing flags
                const numFlags = 20; // More flags for a better shuffle effect
                const containerWidth = flagsContainer.offsetWidth;
                const containerHeight = flagsContainer.offsetHeight;

                for (let i = 0; i < numFlags; i++) {
                    const img = document.createElement('img');
                    const randomFlagCode = flagCodes[Math.floor(Math.random() * flagCodes.length)];
                    img.src = `/static/flags/${randomFlagCode}.svg`;
                    img.alt = 'Flag';

                    // Set initial random position
                    img.style.left = `${Math.random() * (containerWidth - 80)}px`; // 80px is flag width
                    img.style.top = `${Math.random() * (containerHeight - 60)}px`; // 60px is flag height

                    // Set random CSS variables for animation
                    img.style.setProperty('--random-x-1', Math.random() * 100 - 50); // -50 to 50
                    img.style.setProperty('--random-y-1', Math.random() * 100 - 50);
                    img.style.setProperty('--random-deg-1', Math.random() * 90 - 45); // -45 to 45
                    img.style.setProperty('--random-scale-1', Math.random()); // 0 to 1

                    img.style.setProperty('--random-x-2', Math.random() * 100 - 50);
                    img.style.setProperty('--random-y-2', Math.random() * 100 - 50);
                    img.style.setProperty('--random-deg-2', Math.random() * 90 - 45);
                    img.style.setProperty('--random-scale-2', Math.random());

                    img.style.setProperty('--random-x-3', Math.random() * 100 - 50);
                    img.style.setProperty('--random-y-3', Math.random() * 100 - 50);
                    img.style.setProperty('--random-deg-3', Math.random() * 90 - 45);
                    img.style.setProperty('--random-scale-3', Math.random());

                    // Set random animation delay and duration
                    img.style.animationDelay = `${Math.random() * 0.5}s`;
                    img.style.animationDuration = `${2.5 + Math.random() * 1}s`; // 2.5s to 3.5s

                    flagsContainer.appendChild(img);
                }
            }

            // Modify startGame function
            function startGame() {
                // Show animation overlay
                populateFlagsForAnimation(); // Populate flags before showing
                shuffleAnimationOverlay.classList.remove('hidden');

                setTimeout(() => {
                    shuffleAnimationOverlay.classList.add('hidden'); // Hide animation overlay

                    startScreen.classList.add('hidden');
                    gameArea.classList.remove('hidden');
                    winScreen.classList.add('hidden');
                    loseScreen.classList.add('hidden');
                    feedbackArea.textContent = '';
                    wrongGuessesList.innerHTML = '';
                    errorCountEl.textContent = '0';
                    totalAttemptsEl.textContent = '0';
                    guessInput.value = '';
                    guessInput.focus();

                    const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;

                    fetch('/start_game', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ difficulty: selectedDifficulty })
                    })
                        .then(res => res.json())
                        .then(data => {
                            initialLetterEl.textContent = data.initial_letter;
                        });
                }, 3000); // 3 seconds animation
            }

            startGameBtn.addEventListener('click', startGame);
            viewRankingBtn.addEventListener('click', () => {
                window.location.href = '/ranking';
            });
            viewRankingBtnWin.addEventListener('click', () => {
                window.location.href = '/ranking';
            });
            viewRankingBtnLose.addEventListener('click', () => {
                window.location.href = '/ranking';
            });

            guessForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const guess = guessInput.value.trim();
                if (!guess) return;

                fetch('/guess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guess: guess })
                })
                .then(res => res.json())
                .then(data => {
                    feedbackArea.textContent = data.message || '';
                    if (data.status === 'win') {
                        showWinScreen(data);
                    } else if (data.status === 'lose') {
                        showLoseScreen(data);
                    } else if (data.status === 'wrong') {
                        updateWrongGuesses(data.wrong_guesses, data.attempts);
                    }
                    guessInput.value = '';
                });
            });

            function updateWrongGuesses(guesses, attempts) {
                totalAttemptsEl.textContent = attempts;
                errorCountEl.textContent = guesses.length;
                wrongGuessesList.innerHTML = '';
                guesses.forEach(g => {
                    const li = document.createElement('li');
                    li.textContent = g;
                    wrongGuessesList.appendChild(li);
                });
            }

            function showWinScreen(data) {
                gameArea.classList.add('hidden');
                winScreen.classList.remove('hidden');
                
                document.getElementById('win-message').textContent = `Você acertou! O país era ${data.country_name}.`;
                document.getElementById('country-flag').src = `/static/flags/${data.flag_code}.svg`;
                document.getElementById('final-time').textContent = data.time_spent;
                document.getElementById('final-attempts').textContent = data.attempts;
                totalAttemptsEl.textContent = data.attempts;

                finalTime = data.time_spent;
                finalAttempts = data.attempts;
            }

            function showLoseScreen(data) {
                gameArea.classList.add('hidden');
                loseScreen.classList.remove('hidden');
                document.getElementById('lose-message').textContent = "Você não conseguiu adivinhar a tempo!";
                document.getElementById('correct-country').textContent = data.country_name;
                document.getElementById('country-flag-lose').src = `/static/flags/${data.flag_code}.svg`;
                document.getElementById('lose-attempts').textContent = data.attempts;
            }

            rankingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const playerName = document.getElementById('player-name').value.trim();
                if (!playerName) return;

                fetch('/save_ranking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_name: playerName })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'success') {
                        window.location.href = '/ranking';
                    } else {
                        alert("Erro ao salvar no ranking: " + data.error)
                    }
                });
            });

            function resetToStartScreen() {
                winScreen.classList.add('hidden');
                loseScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }

            playAgainBtn.addEventListener('click', resetToStartScreen);
            playAgainBtnLose.addEventListener('click', resetToStartScreen);

            const giveUpBtn = document.getElementById('give-up-btn');

            giveUpBtn.addEventListener('click', () => {
                fetch('/give_up', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'given_up') {
                            showGiveUpScreen(data);
                        } else {
                            alert('Erro ao desistir da rodada: ' + data.error);
                        }
                    });
            });

            function showGiveUpScreen(data) {
                gameArea.classList.add('hidden');
                loseScreen.classList.remove('hidden'); // Reusing lose screen for now
                document.getElementById('lose-message').textContent = "Você desistiu da rodada!";
                document.getElementById('correct-country').textContent = data.country_name;
                document.getElementById('country-flag-lose').src = `/static/flags/${data.flag_code}.svg`;
                document.getElementById('lose-attempts').textContent = data.attempts; // Display attempts up to giving up
            }

        });
    </script>
</body>
</html>
